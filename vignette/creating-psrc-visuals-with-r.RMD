---
title: "Creating PSRC Visuals with R"
output: 
  html_document: 
    theme: cerulean
    toc: TRUE
    toc_float: TRUE
    toc_depth: 2
---

Creating visually interesting data visualizations with R is fun but can sometimes seem overwhelming. There are so many options and packages that many times it feels easier to default to other tools. At PSRC, staff  decided to try and tackle this problem so that we can streamline the creation of PSRC consistent data visualizations by creating an easy to use package in R titled **psrcplot**. The package is built on **ggplot2** and it combines PSRC color palettes, font styles and plot themes with custom functions to create a range of standard charts used at PSRC. The package currently offers functions to create:  

* Bar Charts 
* Facet Wraps for Bar Charts  
* Line Charts  
* Bubble Charts  
* Treemap Charts  
  
# Packages  

This tutorial is intended to give users a taste of what you can do using **psrcplot**. We will be using a couple packages in R to work through our examples:  
  
1. *psrctrends*: This is a package that staff have developed to streamline the processing of data used in standard trends.  
2. *psrcplot*: This is a package that staff have developed to streamline the creation of PSRC styled data visualizations.  
3. *tidyverse*: A nice package with lots of tools to perform any necessary data processing, filtering or transforming in our plot examples.  

## Install packages    

If you do not already have these packages installed, or you want to make sure you have the latest version, you always can start by installing them. The two packages from **PSRC** are installed via GitHub and dplyr can be installed from CRAN. To install the packages:  

```{r install-packages, eval=FALSE}

devtools::install_github("psrc/psrctrends")
devtools::install_github("psrc/psrcplot")
install.packages("tidyverse")

```

## Load Packages  

After you have the packages installed on your pc, you can load them into your R session using:  

```{r setup-for-document, eval=FALSE}

library(psrctrends)
library(psrcplot)
library(tidyverse)

```

```{r setup, include=FALSE}

library(psrctrends)
library(psrcplot)
library(tidyverse)

```

## Using Poppins - the PSRC Font

A new font family came along with the launch of the new PSRC website - a very visually appealing font family called **Poppins**. The **Poppins** font is a member of the [Google Font Family](https://fonts.google.com/?query=poppins) so it is available to any web-browser and makes text easier to read for all users. The font is great but it requires a few steps in order for you to use it within R.

1. The font needs to be installed on your computer and located in **"C:\\Windows\\Fonts"** directory. This only needs to be done once but until it is done, even if your call for **Poppins** fonts, all your R generated documents will default to Times New Roman. To install the font family, first [Click here to download the font family](https://fonts.google.com/download?family=Poppins) and then copy the contents of the zipfile to the **"C:\\Windows\\Fonts"** directory.
2. R Studio defaults to a standard set of five fonts that it always uses. Each time you start a new R session you can tell it to use other fonts but the next time you load R you have to tell it to do it again. We have built a function into **psrcplot** that takes care of this step for you. At the start of each project, right after you load libraries, you can load the fonts them into your R session using:

```{r font-setup-for-document, eval=FALSE}

install_psrc_fonts()

```

```{r font-setup, include=FALSE}

install_psrc_fonts()

```


## PSRC Color Palettes

PSRC graphics staff have created custom color palettes across 5 color's for use in the agencies work products. Each main color has six(6) defined colors allowing for a total of thirty(30) unique colors that can be used in data visualizations. In **psrcplot**, we have created color palettes in R (similar to those you would see with RColorBrewer) that can be used by staff. Let's take a look at what these palettes are called and look like by calling the function *print_psrc_palette*.  

```{r color-palette, echo=TRUE, out.width="100%", fig.align='center'}
print_psrc_palette()
```

# Chart Types {.tabset .tabset-fade .tabset-pills}   

The tabs below will take you through various options for creating specific chart types using **psrcplot**. The examples do not show each and every variation you can make but try to highlight some key things that a user can do with the package. Each code chunk is provided so you should be able to follow along in RStudio and create similar outputs. 

## Column (Vertical Bar) Charts

As part of the Equity Tracker data pipeline work, a variety of equity related data from the the PUMS package have been loaded in Elmer, the agencies central database. Let's take a look at how we can access that data using **psrctrends** and then create some different plots using **psrcplots**.  Grabbing data from Elmer via **psrctrends** requires a network connection (either in-office or via VPN) and is called with one function - *get_elmer_table*.  Let's grab equity related data from Elmer that is currently being developed for use in the Equity Tracker work.

```{r equity-data-elmer, echo=TRUE}
pums.equity.data <- get_elmer_table("equity.indicator_facts")
```

Now that we have all that various equity data loaded into a tibble in R, let's go ahead and create a column chart that displays Median Household Income by English Proficiency by County. We accomplish this by first **filtering** the overall data to our desired attributes and using **static_column_chart** from PSRC plot.  

```{r income-lep, echo=TRUE}
tbl <- pums.equity.data %>% filter(focus_type=="LEP_cat" 
                                   & indicator_type=="median_household_income" 
                                   & focus_attribute!="Total"
                                   & county!="Region")

income_lep_chart <- static_column_chart(t=tbl, x="county", y="fact_value", 
                                        fill="focus_attribute", 
                                        moe="margin_of_error", 
                                        est="currency",
                                        dec=-2,
                                        color="pgnobgy_5")

ggsave("income_lep_chart.png", income_lep_chart, width = 800, height = 600, dpi="screen", units = "px")

```

Now you can display the image in your pdf or html document using **include_graphics** function from knitr. Displaying images this way gives the user flexibility over the final look and feel of the embedded image. Here is our chart.  

```{r income-lep-for-document, eval=FALSE}
income_lep_chart
```

```{r income-lep-display, echo=FALSE}
income_lep_chart
```

What happened to our chart - the text is so small and the image only takes half the screen. This is due to the way images are rendered between RMarkdown and their final output. When you use **include_graphics**, a key parameter you need to pass to it is **dpi**. This parameter defines the width of the image being displayed as the images actual pixel width divided by the dpi value. If you want your image to span the screen and the font size to match your original image, set the **dpi=72**

